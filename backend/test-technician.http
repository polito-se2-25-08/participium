### Technician Flow Test
### Adjust tokens / IDs after running each step.

@baseUrl = http://localhost:3000/api
@adminUsername = Haland
@adminPassword = Secret123!
@adminToken = eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpZCI6MzAsInJvbGUiOiJBRE1JTiIsImlhdCI6MTc2NDA3NTA2MSwiZXhwIjoxNzY0MDc4NjYxfQ.lzpVG4INfGyyCj5S06RiEVLCP_6w2Rf22xGBLu6pZ8g

@techUsername = tech_user_cat5
@techEmail = tech_user_cat5@example.com
# Fill after creation response:
@techUserId = 42
@techPassword = [hLeT3:K)d$
@techToken = eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpZCI6NDIsInJvbGUiOiJURUNITklDSUFOIiwiaWF0IjoxNzY0MDczODI0LCJleHAiOjE3NjQwNzc0MjR9.Y2vJ0cfwEJV_UGQcMRekym6c5AHc_h1sRtSwCQj6SGU


###############################################
# 0. Login and Get JWT Token
###############################################
# @name login
POST {{baseUrl}}/v1/login
Content-Type: application/json

{
  "username": "{{adminUsername}}",
  "password": "{{adminPassword}}"
}

############################################################
# 1. Admin creates a TECHNICIAN user (password returned)
############################################################
POST {{baseUrl}}/v1/admin/register
Authorization: Bearer {{adminToken}}
Content-Type: application/json

{
  "email": "{{techEmail}}",
  "username": "{{techUsername}}",
  "role": "TECHNICIAN",
  "name": "Tech",
  "surname": "User"
}

### After this, copy:
### - data.id -> @techUserId
### - data.password (plain) -> @techPassword

############################################################
# 2. Admin assigns category to technician (e.g. category_id = 5)
############################################################
PUT {{baseUrl}}/v1/admin/technicians/{{techUserId}}/category
Authorization: Bearer {{adminToken}}
Content-Type: application/json

{
  "category_id": 2
}

### Error case: invalid category (e.g. 0)
PUT {{baseUrl}}/v1/admin/technicians/{{techUserId}}/category
Authorization: Bearer {{adminToken}}
Content-Type: application/json

{
  "category_id": 0
}

############################################################
# 3. Technician login to obtain JWT
############################################################
# @name technicianLogin
POST {{baseUrl}}/v1/login
Content-Type: application/json

{
  "username": "{{techUsername}}",
  "password": "{{techPassword}}"
}

### Copy returned token -> @techToken

############################################################
# 4. Technician fetch reports for their category (default status = ASSIGNED)
############################################################
GET {{baseUrl}}/v1/technician/reports
Authorization: Bearer {{techToken}}

### With explicit status filter
GET {{baseUrl}}/v1/technician/reports?status=IN_PROGRESS
Authorization: Bearer {{techToken}}

### With explicit status filter
GET {{baseUrl}}/v1/technician/reports?status=SUSPENDED
Authorization: Bearer {{techToken}}

### With explicit status filter
GET {{baseUrl}}/v1/technician/reports?status=RESOLVED
Authorization: Bearer {{techToken}}

### With explicit status filter
GET {{baseUrl}}/v1/technician/reports?status=REJECTED
Authorization: Bearer {{techToken}}

### Error: missing token
GET {{baseUrl}}/v1/technician/reports

### Error: wrong role (use a CITIZEN token)
GET {{baseUrl}}/v1/technician/reports
Authorization: Bearer <CITIZEN_TOKEN>

############################################################
# (Optional) NEEDS VERIFICATION Seed reports (requires existing report creation route)
# Ensure some reports exist with category_id = 5 and status = ASSIGNED / IN_PROGRESS
############################################################
#POST {{baseUrl}}/v1/reports
#Authorization: Bearer {{adminToken}}
#Content-Type: application/json
#{
#  "title": "Broken streetlight",
#  "description": "Lamp not working",
#  "latitude": "45.067",
#  "longitude": "7.682",
#  "anonymous": false,
#  "category_id": 5
#}


############################################################
# Update Report Status (Technician)
# PATCH /v1/reports/:id/status
# Sets status to one of:
# "ASSIGNED" | "IN_PROGRESS" | "SUSPENDED" | "RESOLVED"
############################################################
### Update report status
PATCH {{baseUrl}}/v1/reports/19/status
Content-Type: application/json

{
  "status": "IN_PROGRESS"
}

### Send a message on a report
POST {{baseUrl}}/v1/reports/19/messages
Content-Type: application/json
Authorization: Bearer YOUR_TOKEN_HERE

{
  "message": "Hello, any updates?"
}

### Get unread notifications (simulate login)
GET {{baseUrl}}/v1/notifications
###Authorization: Bearer YOUR_TOKEN_HERE

### Get messages for a report
GET {{baseUrl}}/v1/reports/19/messages
###Authorization: Bearer YOUR_TOKEN_HERE

### Mark notification as read
PATCH {{baseUrl}}/v1/notifications/1/read
###Authorization: Bearer YOUR_TOKEN_HERE